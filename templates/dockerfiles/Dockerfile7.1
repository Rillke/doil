# Fetch Ubuntu
FROM ubuntu:latest

# Update apt
RUN apt-get update
RUN apt-get upgrade -y

# Debian configs
COPY conf/debconf.selections /tmp/
RUN debconf-set-selections /tmp/debconf.selections

# Set ENV
ENV ALLOW_OVERRIDE All
ENV DATE_TIMEZONE UTC
ENV TERM dumb

# Prevent interactions for TZ configuration
ARG DEBIAN_FRONTEND=noninteractive
ENV TZ=Europe/Berlin
RUN ln -snf /usr/share/zoneinfo/$TZ /etc/localtime && echo $TZ > /etc/timezone

# Install standard packages
RUN apt-get install -y zip unzip git nodejs composer nano tree vim curl ftp imagemagick ffmpeg phantomjs vim

# Install php 7.1
RUN apt-get update
RUN apt-get install -y software-properties-common
RUN add-apt-repository -y ppa:ondrej/php
RUN apt-get update
RUN apt-get install -y php7.1 php7.1-bz2 php7.1-cgi php7.1-cli php7.1-common php7.1-curl php7.1-dev php7.1-enchant php7.1-fpm php7.1-gd php7.1-gmp php7.1-imap php7.1-interbase php7.1-intl php7.1-json php7.1-ldap php7.1-mbstring php7.1-mysql php7.1-odbc php7.1-opcache php7.1-pgsql php7.1-phpdbg php7.1-pspell php7.1-readline php7.1-recode php7.1-snmp php7.1-sqlite3 php7.1-sybase php7.1-tidy php7.1-xmlrpc php7.1-xsl php7.1-zip php7.1-soap

# Install apache2
RUN apt-get install -y apache2 libapache2-mod-php7.1

# Install Mailserver
RUN apt-get install -y postfix

# Install Bower Packages
RUN apt-get install -y npm
RUN npm install -g grunt-cli less

# Relink everything
RUN a2enmod rewrite

# Set the volumes
VOLUME /var/www/html
VOLUME /var/ilias
VOLUME /var/log/httpd
VOLUME /var/lib/mysql
VOLUME /var/log/mysql
VOLUME /etc/apache2

# Make folders accessable
RUN chown -R www-data:www-data /var/www
RUN chown -R www-data:www-data /var/ilias

# Run server
COPY conf/run-lamp.sh /var/www/
RUN chmod +x /var/www/run-lamp.sh
CMD ["/var/www/run-lamp.sh"]
